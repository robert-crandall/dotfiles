#!/bin/bash
# GitHub codespaces setup. This file is run automatically on codespaces startup.
# See https://docs.github.com/en/codespaces/customizing-your-codespace/personalizing-github-codespaces-for-your-account

exec > >(tee -i $HOME/dotfiles_install.log)
exec 2>&1
set -x

[ $(uname -s) = "Darwin" ] && export MACOS=1 && export UNIX=1
[ $(uname -s) = "Linux" ] && export LINUX=1 && export UNIX=1
uname -s | grep -q "_NT-" && export WINDOWS=1

if [ $MACOS ]
then
  VSCODE="$HOME/Library/Application Support/Code/User"
elif [ $LINUX ]
then
  VSCODE="$HOME/.config/Code/User"
elif [ $WINDOWS ]
then
  VSCODE="$APPDATA/Code/User"
fi

function mac_link_files() {
  if [[ ! $(pwd) -ef $HOME ]]; then
    mkdir -p ~/.config/

    ## Git config
    rm -f ~/.gitignore_global
    ln -s $(pwd)/settings/gitignore_global ~/.gitignore_global

    rm -f ~/.gitconfig
    ln -s $(pwd)/settings/gitconfig ~/.gitconfig

    ## SSH
    mkdir -p ~/.ssh/
    rm -rf ~/.ssh/config
    ln -s $(pwd)/settings/ssh ~/.ssh/config

    # Fixup VSCode settings path
    mkdir -p "$VSCODE"
    rm -f "$VSCODE/settings.json"
    ln -s $(pwd)/settings/vscode.json "$VSCODE/settings.json"
  fi
}

function link_zsh() {
  if [[ ! $(pwd) -ef $HOME ]]; then
    rm -f ~/.zshrc
    ln -s $(pwd)/settings/zshrc ~/.zshrc

    rm -f ~/.zshenv
    ln -s $(pwd)/settings/zshenv ~/.zshenv

    mkdir -p ~/.config/
    rm -rf ~/.config/zsh
    ln -s $(pwd)/config/zsh ~/.config/

    rm -f ~/.p10k.zsh
    ln -s $(pwd)/config/zsh/p10k.zsh ~/.p10k.zsh
  fi
}

function link_fish() {
  if [[ ! $(pwd) -ef $HOME ]]; then
    rm -rf ~/.config/fish
    ln -s $(pwd)/config/fish ~/.config/

    rm -f ~/.config/starship.toml
    ln -s $(pwd)/config/starship.toml ~/.config/starship.toml
  fi
}

function install_starship() {
  if ! which starship > /dev/null
  then
    if [ $MACOS ]
    then
      brew install --cask finicky
      curl -fsSL https://starship.rs/install.sh | sh
    elif [ $LINUX ]
    then
      curl -sL https://starship.rs/install.sh | sh -s -- -y
    fi
    sleep 5
  fi
}

if [ $MACOS ]
then
  echo 'ðŸ”— Linking Mac files.'
  echo `date +"%Y-%m-%d %T"`
  install_starship
  mac_link_files
  link_fish
elif [ $LINUX ]
then
  install_starship
  link_fish
fi
